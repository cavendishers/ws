{% extends 'data_hall/base.html' %}
{% load static %}

{% block title %}{{ industry_name }}产业链图谱 - 中国新势力企业态势感知系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
    :root {
        /* 主要配色 - 优化后的暗黑暗紫主题，降低对比度 */
        --primary: #121022;
        --secondary: #7A57D1;
        --secondary-rgb: 122, 87, 209;
        --accent: #5EDFDF;
        --accent-rgb: 94, 223, 223;
        --card-bg: #1C1630;
        --input-bg: #272042;
        --text-primary-light: #E8E4F4;
        --text-secondary-light: #C7BFDE;
        --text-muted-light: #8D80A6;
        --border-light: rgba(122, 87, 209, 0.15);
        
        /* 图谱特定颜色 - 降低亮度的科技感配色 */
        --upstream-color: #5039A3;
        --upstream-light-color: #7457D3;
        --upstream-bg-title: #1E1A36;
        --upstream-border-accent: #5D44B8;

        --midstream-color: #1B7A84;
        --midstream-light-color: #4BABB5;
        --midstream-bg-title: #182F33;
        --midstream-border-accent: #288A95;

        --downstream-color: #9A3677;
        --downstream-light-color: #B86295;
        --downstream-bg-title: #2C1C2E;
        --downstream-border-accent: #A44382;
    }

    /* 图表特定样式 */
    .chart-view-options {
        padding: 0px 0px;
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
    }

    .view-option {
        background-color: var(--input-bg);
        border: 1px solid var(--border-light);
        padding: 6px 12px;
        margin-left: -1px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-secondary-light);
        transition: all 0.2s ease;
    }
    .view-option:first-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
        margin-left: 0;
    }
    .view-option:last-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    .view-option.active {
        background-color: var(--secondary);
        color: white;
        border-color: var(--secondary);
        box-shadow: 0 0 5px rgba(var(--secondary-rgb), 0.3);
    }
    .view-option:hover:not(.active) {
        background-color: rgba(122, 87, 209, 0.15);
    }

    .graph-main-content-wrapper {
        display: flex;
        flex-grow: 1;
        padding: 0;
        overflow: hidden;
        position: relative;
    }

    #chart-zoom-pan-container {
        flex-grow: 1;
        overflow: auto;
        position: relative;
        cursor: grab;
        background-color: var(--primary);
        border-radius: 4px;
        min-height: 600px;
        background-image: radial-gradient(circle at 10% 20%, rgba(122, 87, 209, 0.03) 0%, transparent 70%);
    }

    #industry-chain-container {
        display: flex;
        padding: 40px;
        gap: 30px;
        min-width: min-content;
        transform-origin: 0 0;
        transition: transform 0.1s ease-out;
        position: relative;
    }
    .industry-column {
        min-width: 320px;
        padding: 0;
        border-radius: 8px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-self: flex-start;
        background-color: var(--primary);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), 0 0 10px rgba(122, 87, 209, 0.05);
        border: 1px solid rgba(122, 87, 209, 0.08);
    }
    
    /* 增加不同列数的列宽度 */
    .industry-column.width-columns-2 {
        min-width: 650px;
        max-width: 700px;
    }
    
    .industry-column.width-columns-3 {
        min-width: 950px;
        max-width: 1020px;
    }
    
    .industry-column.width-columns-4 {
        min-width: 1250px;
        max-width: 1340px;
    }
    
    .industry-column .column-title-container {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
        text-align: center;
    }
    .industry-column .column-title {
        font-size: 18px;
        font-weight: bold;
        color: var(--text-primary-light);
        padding: 8px 15px;
        display: inline-block;
    }

    /* 列特定背景 - 使上中下游标题容器更协调 */
    .upstream-column .column-title-container { 
        background-color: #463299; 
        box-shadow: 0 0 5px rgba(93, 68, 184, 0.1); 
    }
    .midstream-column .column-title-container { 
        background-color: #1a6f79; 
        box-shadow: 0 0 5px rgba(40, 138, 149, 0.1); 
    }
    .downstream-column .column-title-container { 
        background-color: #8f2f6c; 
        box-shadow: 0 0 5px rgba(164, 67, 130, 0.1); 
    }

    .node-level-1 {
        color: var(--text-primary-light);
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
    }


    .upstream-column .node-level-1 { 
        background-color: var(--upstream-color);
        box-shadow: 0 2px 8px rgba(80, 57, 163, 0.2);
    }
    .midstream-column .node-level-1 { 
        background-color: var(--midstream-color);
        box-shadow: 0 2px 8px rgba(27, 122, 132, 0.2);
    }
    .downstream-column .node-level-1 { 
        background-color: var(--downstream-color);
        box-shadow: 0 2px 8px rgba(154, 54, 119, 0.2);
    }

    /* 减弱边缘发光效果 */
    .node-level-1::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    .node-level-2 {
        color: var(--text-primary-light);
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: 500;
        text-align: center;
        margin-top: 10px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .upstream-column .node-level-2 { 
        background-color: var(--upstream-light-color);
        box-shadow: 0 2px 6px rgba(116, 87, 211, 0.15);
    }
    .midstream-column .node-level-2 { 
        background-color: var(--midstream-light-color);
        box-shadow: 0 2px 6px rgba(75, 171, 181, 0.15);
    }
    .downstream-column .node-level-2 { 
        background-color: var(--downstream-light-color);
        box-shadow: 0 2px 6px rgba(184, 98, 149, 0.15);
    }

    .node-level-1-items-container,
    .node-level-2-items-container,
    .node-level-3-items-container {
        background-color: var(--card-bg);
        border: 1px solid var(--border-light);
        border-radius: 4px;
        padding: 10px;
        margin-top: 5px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    /* 多列布局样式 - 解决垂直堆叠高度过大问题 */
    .node-level-1-items-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
    }
    
    /* 当子节点数量较多时应用多列布局 */
    .multi-column-layout {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    
    /* 针对不同数量级的子节点优化列数 */
    .columns-2 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .columns-3 {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .columns-4 {
        grid-template-columns: repeat(4, 1fr);
    }
    
    /* 确保多列情况下节点保持原尺寸 */
    .multi-column-layout > .node-level-2,
    .multi-column-layout > .node-level-3,
    .multi-column-layout > .node-level-4 {
        min-width: 280px;
        max-height: fit-content;
    }

    .node-level-3, .node-level-4 {
        background-color: var(--input-bg);
        border: 1px solid var(--border-light);
        color: var(--text-secondary-light);
        padding: 8px 10px;
        border-radius: 4px;
        text-align: center;
        font-size: 13px;
        transition: all 0.2s ease;
    }
    .node-level-3:hover, .node-level-4:hover {
        border-color: var(--accent);
        color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(94, 223, 223, 0.1);
    }

    .horizontal-group-parent > .node-level-2-items-container,
    .horizontal-group-parent > .node-level-3-items-container {
        flex-direction: row;
        justify-content: space-around;
        flex-wrap: wrap;
    }
    .horizontal-group-parent > .node-level-2-items-container > .node-level-3,
    .horizontal-group-parent > .node-level-3-items-container > .node-level-4 {
        flex-grow: 1;
        min-width: 100px;
    }

    .arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: var(--accent);
        align-self: flex-start;
        padding-top: 180px;
        min-width: 40px;
        text-shadow: 0 0 5px rgba(94, 223, 223, 0.3);
    }

    /* 侧边栏操作 */
    .graph-sidebar-actions {
        width: 70px;
        background-color: var(--card-bg);
        border-left: 1px solid var(--border-light);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        margin-left: 20px;
        border-radius: 4px;
        height: fit-content;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), 0 0 10px rgba(122, 87, 209, 0.05);
    }
    .graph-sidebar-icon-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    .graph-sidebar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        color: var(--text-secondary-light);
        font-size: 11px;
        text-align: center;
        width: 100%;
        padding: 8px 0;
        transition: all 0.2s ease;
    }
    .graph-sidebar-item i {
        width: 22px;
        height: 22px;
        margin-bottom: 4px;
    }
    .graph-sidebar-item:hover {
        color: var(--accent);
        text-shadow: 0 0 3px rgba(94, 223, 223, 0.3);
    }

    /* 页脚 */
    .graph-footer {
        background-color: var(--card-bg);
        text-align: center;
        padding: 15px;
        font-size: 12px;
        color: var(--text-muted-light);
        border-top: 1px solid var(--border-light);
        margin-top: 1.5rem;
        border-radius: 4px;
    }
    
    .section-card {
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-light);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2), 0 0 10px rgba(122, 87, 209, 0.08);
        background-image: linear-gradient(135deg, rgba(122, 87, 209, 0.03) 0%, rgba(0, 0, 0, 0) 70%);
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary-light);
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .section-title i {
        color: var(--accent);
        text-shadow: 0 0 3px rgba(94, 223, 223, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-4">
    <!-- 产业链图谱 -->
    <section class="section-card" id="industry-chain-section">
        <h2 class="section-title">
            <i class="fas fa-project-diagram text-[var(--accent)]"></i>
            <span>{{ industry_name }}产业链图谱</span>
        </h2>

        <!-- 视图选项 -->
        <div class="chart-view-options">
            <button class="view-option active">框架图</button>
            <button class="view-option">树状图</button>
        </div>

        <!-- 图表区域 -->
        <div class="graph-main-content-wrapper mt-4">
            <div id="chart-zoom-pan-container">
                <div id="industry-chain-container">
                    <!-- 图谱内容由JS动态生成 -->
                </div>
            </div> 

            <aside class="graph-sidebar-actions">
                <div class="graph-sidebar-icon-group">
                    <div class="graph-sidebar-item" title="指示器">
                        <svg class="gauge-svg-placeholder" viewBox="0 0 50 50" width="22" height="22" style="fill:currentColor">
                            <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-opacity="0.3" stroke-width="4"/>
                            <path d="M25 5 A20 20 0 0 1 43.3 16.7" fill="none" stroke="currentColor" stroke-width="4"/>
                            <circle cx="25" cy="25" r="3" fill="currentColor"/>
                            <line x1="25" y1="25" x2="43" y2="17" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>指示器</span>
                    </div>
                    <div class="graph-sidebar-item" title="刷新">
                        <i class="fas fa-sync-alt"></i>
                        <span>刷新</span>
                    </div>
                    <div class="graph-sidebar-item" title="全屏">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>全屏</span>
                    </div>
                    <div class="graph-sidebar-item" title="去水印">
                        <i class="fas fa-tint-slash"></i>
                        <span>去水印</span>
                    </div>
                    <div class="graph-sidebar-item" title="下载">
                        <i class="fas fa-download"></i>
                        <span>下载</span>
                    </div>
                    <div class="graph-sidebar-item" title="保存">
                        <i class="fas fa-save"></i>
                        <span>保存</span>
                    </div>
                </div>
            </aside>
        </div>
    </section>
    
    <!-- 页脚信息 -->
    <footer class="graph-footer">
        以上数据基于公开信息分析挖掘的成果，仅供参考，不构成任何明示或暗示的观点或保证。
    </footer>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 从后端获取产业链数据
    const graphData = JSON.parse('{{ chain_data|escapejs }}');
    document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('industry-chain-container');
    const zoomPanContainer = document.getElementById('chart-zoom-pan-container');

    if (!graphData || !graphData.Children) {
        console.error('graphData is not defined or has no Children property.');
        container.innerHTML = '<p style="color:red; text-align:center;">Error: Graph data not found.</p>';
        return;
    }
    
    renderGraph(graphData.Children, container);

    let scale = 1;
    let panning = false;
    let pointX = 0;
    let pointY = 0;
    let start = { x: 0, y: 0 };
    let translateX = 0;
    let translateY = 0;

    function setTransform() {
        container.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    zoomPanContainer.onmousedown = function (e) {
        e.preventDefault();
        start = { x: e.clientX - translateX, y: e.clientY - translateY };
        panning = true;
        zoomPanContainer.style.cursor = 'grabbing';
    };

    zoomPanContainer.onmouseup = function () {
        panning = false;
        zoomPanContainer.style.cursor = 'grab';
    };

    zoomPanContainer.onmouseleave = function () { // Stop panning if mouse leaves container
        panning = false;
        zoomPanContainer.style.cursor = 'grab';
    };

    zoomPanContainer.onmousemove = function (e) {
        e.preventDefault();
        if (!panning) {
            return;
        }
        translateX = e.clientX - start.x;
        translateY = e.clientY - start.y;
        setTransform();
    };

    zoomPanContainer.onwheel = function (e) {
        e.preventDefault();
        const xs = (e.clientX - translateX) / scale;
        const ys = (e.clientY - translateY) / scale;
        const delta = (e.wheelDelta ? e.wheelDelta : -e.deltaY);

        (delta > 0) ? (scale *= 1.1) : (scale /= 1.1);
        scale = Math.min(Math.max(0.2, scale), 4); // Min 0.2x, Max 4x zoom

        translateX = e.clientX - xs * scale;
        translateY = e.clientY - ys * scale;

        setTransform();
    };

    // 添加视图选项的点击事件
    const viewOptions = document.querySelectorAll('.view-option');
    viewOptions.forEach(option => {
        option.addEventListener('click', function() {
            viewOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
        });
    });
});

    function renderGraph(nodes, parentElement) {
        const mainColumnsData = {
            "上游": [],
            "中游": [],
            "下游": []
        };

        // Group top-level nodes by their NodeNumDesc
        nodes.forEach(node => {
            if (node.NodeNumDesc && mainColumnsData[node.NodeNumDesc]) {
                mainColumnsData[node.NodeNumDesc].push(node);
            } else {
                // Fallback or error handling if NodeNumDesc is unexpected
                console.warn("Node with unexpected NodeNumDesc:", node.NodeNumDesc, node);
            }
        });
        
        const columnOrder = ["上游", "中游", "下游"];
        columnOrder.forEach((columnName, index) => {
            if (mainColumnsData[columnName].length > 0) {
                const columnDiv = createColumn(columnName);
                mainColumnsData[columnName].forEach(node => {
                    // NodeLevel 1 items are the main blocks within a column
                    const nodeElement = createNodeElement(node);
                    columnDiv.appendChild(nodeElement);
                });
                parentElement.appendChild(columnDiv);
            }
            // Add arrow if not the last column
            if (index < columnOrder.length - 1 && mainColumnsData[columnOrder[index+1]].length > 0) {
                const arrow = document.createElement('div');
                arrow.className = 'arrow';
                arrow.innerHTML = '→';
                parentElement.appendChild(arrow);
            }
        });
    }

    function createColumn(title) {
        const columnDiv = document.createElement('div');
        let columnClass = '';
        if (title === '上游') columnClass = 'upstream-column';
        else if (title === '中游') columnClass = 'midstream-column';
        else if (title === '下游') columnClass = 'downstream-column';
        
        columnDiv.className = `industry-column ${columnClass}`;

        const titleContainer = document.createElement('div');
        titleContainer.className = 'column-title-container';
        const titleEl = document.createElement('span');
        titleEl.className = 'column-title';
        titleEl.textContent = title;
        titleContainer.appendChild(titleEl);
        columnDiv.appendChild(titleContainer);
        
        return columnDiv;
    }

    function createNodeElement(nodeData) {
        const nodeElement = document.createElement('div');
        nodeElement.className = `node-level-${nodeData.NodeLevel}`;
        // 如果是顶级分类节点（上游/中游/下游），不显示文本
        if (nodeData.NodeNumDesc && ["上游", "中游", "下游"].includes(nodeData.NodeNumDesc)) {
            // 不设置文本内容
        } else {
            // 为非顶级节点创建标题元素
            const titleElement = document.createElement('div');
            titleElement.className = 'node-title';
            titleElement.textContent = nodeData.NodeName;
            nodeElement.appendChild(titleElement);
        }

        if (nodeData.Children && nodeData.Children.length > 0) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = `node-level-${nodeData.NodeLevel}-items-container`;
            
            // 根据子节点数量来动态设置列数
            if (nodeData.NodeLevel === 1) {
                // 递归计算所有子孙节点的总数量
                const childCount = countAllDescendants(nodeData);
                console.log(`${nodeData.NodeName} 的所有子孙节点数量: ${childCount}`);
                
                // 根据子孙节点总数量动态决定分几列
                if (childCount > 100) {
                    childrenContainer.classList.add('columns-4');
                    // 查找最近的industry-column父元素并设置宽度类
                    let columnParent = nodeElement.closest('.industry-column');
                    if (columnParent) {
                        columnParent.classList.add('width-columns-4');
                    }
                } else if (childCount > 50) {
                    childrenContainer.classList.add('columns-3');
                    // 查找最近的industry-column父元素并设置宽度类
                    let columnParent = nodeElement.closest('.industry-column');
                    if (columnParent) {
                        columnParent.classList.add('width-columns-3');
                    }
                } else if (childCount > 20) {
                    childrenContainer.classList.add('columns-2');
                    // 查找最近的industry-column父元素并设置宽度类
                    let columnParent = nodeElement.closest('.industry-column');
                    if (columnParent) {
                        columnParent.classList.add('width-columns-2');
                    }
                } else {
                    childrenContainer.classList.add('columns-1'); // 默认单列
                }
                childrenContainer.classList.add('multi-column-layout');
            }

            nodeData.Children.forEach(childNode => {
                const childElement = createNodeElement(childNode);
                childrenContainer.appendChild(childElement);
            });
            nodeElement.appendChild(childrenContainer);
        }
        return nodeElement;
    }
    
    // 递归计算节点及其所有子孙节点的总数量
    function countAllDescendants(node) {
        if (!node.Children || node.Children.length === 0) {
            return 0;
        }
        
        let count = node.Children.length; // 直接子节点数量
        
        // 递归计算每个子节点的子孙节点数量
        for (const child of node.Children) {
            count += countAllDescendants(child);
        }
        
        return count;
    }
</script>
{% endblock %}